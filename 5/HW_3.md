## Домашка 3: Базы данных

1. Взять ФТ и НФТ из HW_1
2. Взять сервисы из HW_2
3. Подумать какие БД будут под какие сценарии, описать сценарий выбора
4. Описать дополнительно: репликация, шардинг

## Решение
*Going Green (переработка электроники)*

1. Auth Service - авторизация и аутентификация (OAuth 2.0 + 2FA, ФЗ-152)
2. Client Portal Service - личный кабинет клиента, создание и трекинг заявок
3. Assessment Service - автоматическая + ручная оценка техники (по правилам из Admin Service)
4. Admin Service - управление типами техники, правилами оценки, аналитикой
5. Logistics Service - генерация ярлыков, трекинг доставки, интеграция с Почтой России/СДЭК
6. Payment Service - проверка реквизитов, выплаты, интеграция с Т-Банк/Сбер, соблюдение ФЗ-115
7. Notification Service - уведомления (email, SMS, пуши) клиентам и операторам
8. Marketplace Integration Service - публикация одобренных товаров на yandex-market или аналогах
9. Analytics & Monitoring Service - сбор логов, метрик, ретрай событий, мониторинг отказов

### Выбор БД

| Сервис                                     | Какая БД                  | Почему выбрали                                                                                                              |
| ------------------------------------------ | ------------------------- | --------------------------------------------------------------------------------------------------------------------------- |
| Auth Service (авторизация)                 | PostgreSQL + Redis (кэш)  | PostgreSQL хранит всех пользователей и их данные надёжно; Redis нужен, чтобы быстро проверять сессии и токены без задержек |
| Client Portal (личный кабинет, заявки)     | PostgreSQL                | Тут нужны чёткие записи и история: заявки клиентов, статусы, финальные цены — важны транзакции и надёжность                |
| Assessment Service (оценка техники)        | PostgreSQL                | Тут хранятся правила оценки и результаты — всё строго связано, нужна целостность данных                                    |
| Admin Service (управление системой)        | PostgreSQL                | Все настройки и журналы изменений — важно, чтобы ничего не терялось и всегда можно было откатить изменения                 |
| Logistics Service (трекинг посылок)        | PostgreSQL                | Нужно хранить статусы отправки, трекинг, ярлыки — надёжно, чтобы не потерялись                                            |
| Payment Service (платежи)                  | PostgreSQL                | Финансовые операции → нужны железные гарантии, что деньги не потеряются                                                    |
| Notification Service (уведомления)         | Kafka + PostgreSQL (логи) | Kafka помогает отправлять уведомления в очереди (быстро, масштабируемо), а PostgreSQL хранит, что было отправлено         |
| Marketplace Integration (выгрузка товаров) | Kafka + PostgreSQL        | Kafka обеспечивает отправку данных на маркетплейсы, а PostgreSQL фиксирует статусы, что и куда ушло                        |
| Analytics Service (аналитика)              | ClickHouse                | Огромные объёмы логов и событий → нужны быстрые отчёты и агрегаты; ClickHouse справляется с этим лучше всего               |


### Репликации и шардинг

| Сервис / БД                   | Репликация (зачем и как)                                                                                                                                                                                                    | Шардинг (зачем и как)                                                                                                                                           |
| ----------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| PostgreSQL (основные сервисы) | Делаем копии баз (реплики), чтобы можно было с них читать отчёты и аналитические запросы, а основную нагрузку записи держать на одном главном сервере. Если основной сервер падает, быстро переключаемся на одну из реплик. | Если данных становится слишком много, делим базы по частям: например, заявки клиентов → по регионам или по первым цифрам ID, чтобы один сервер не захлёбывался |
| ClickHouse (аналитика)        | Делаем несколько одинаковых копий (реплик), чтобы отчёты работали быстро и отказ одного сервера не ломал систему                                                                                                           | Разбиваем данные на куски (например, по дате или по ID), чтобы запросы к разным серверам обрабатывались параллельно и быстрее                                  |
| Redis (кэш)                   | Настраиваем «ведущий + запасной» (master + replica), чтобы если ведущий сервер вдруг упал, запасной быстро его заменил                                                                                                     | Redis сам умеет делить данные на куски (шардинг), если используем Redis Cluster. Это нужно, если кэша становится так много, что одного сервера не хватает      |
| Kafka (очереди)               | Репликация на уровне топиков (тем), чтобы если один брокер упал, другой продолжил работу — важные сообщения не теряются                                                                                                    | Делим сообщения по разделам (partition), чтобы разные потребители могли обрабатывать их параллельно и быстрее. Это даёт масштабирование по обработке           |
